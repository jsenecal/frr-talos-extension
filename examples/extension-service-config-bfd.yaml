# ExtensionServiceConfig with BFD and Multiple Peers - No Environment Variables!
---
apiVersion: v1alpha1
kind: ExtensionServiceConfig
name: frr
configFiles:
  # Complete configuration with BFD and multiple peers
  - content: |
      bgp:
        cilium:
          local_asn: 4200099998
          remote_asn: 4200099999
          namespace: cilium
          peering:
            ipv4:
              local: 192.168.250.254
              remote: 192.168.250.255
              prefix: 31
            ipv6:
              local: "fdae:6bef:5e65::1"
              remote: "fdae:6bef:5e65::2"
              prefix: 126

        upstream:
          local_asn: 4200001001        # Your node's ASN
          router_id: 10.10.10.10        # Your node's IP
          router_id_v6: "2001:db8::10"  # Your node's IPv6

          # Multiple peer definitions with individual settings
          peers:
            # Primary leaf switch
            - address: 10.0.0.1
              remote_asn: 48579
              description: "Leaf-SW-01-Primary"
              password: "strongPassword123"
              timers:
                keepalive: 1
                hold: 3
              bfd:
                enabled: true
                profile: aggressive  # Fast detection for primary

            # Secondary leaf switch
            - address: 10.0.0.2
              remote_asn: 48579
              description: "Leaf-SW-02-Secondary"
              password: "strongPassword456"
              timers:
                keepalive: 1
                hold: 3
              bfd:
                enabled: true
                profile: normal     # Standard detection for secondary

            # Tertiary leaf switch (backup)
            - address: 10.0.0.3
              remote_asn: 48580         # Different ASN
              description: "Leaf-SW-03-Backup"
              password: "backupPassword789"
              timers:
                keepalive: 10
                hold: 30
              bfd:
                enabled: true
                profile: relaxed    # Relaxed for backup link
              multihop: 2               # Multi-hop BGP
              update_source: lo         # Use loopback as source

            # IPv6 peers
            - address: "2001:db8:ffff::1"
              remote_asn: 48579
              description: "Leaf-SW-01-IPv6"
              password: "ipv6Password123"
              address_family: ipv6
              bfd:
                enabled: true
                profile: normal

            - address: "2001:db8:ffff::2"
              remote_asn: 48579
              description: "Leaf-SW-02-IPv6"
              password: "ipv6Password456"
              address_family: ipv6
              bfd:
                enabled: false      # BFD disabled for this peer
      network:
        interface_mtu: 1500
        veth_names:
          frr_side: veth-frr
          cilium_side: veth-cilium
      bfd:
        profiles:
          aggressive:
            detect_multiplier: 3
            receive_interval: 100
            transmit_interval: 100
            echo_mode: false
          normal:
            detect_multiplier: 3
            receive_interval: 300
            transmit_interval: 300
            echo_mode: false
          relaxed:
            detect_multiplier: 5
            receive_interval: 1000
            transmit_interval: 1000
            echo_mode: false
        cilium_peering:
          enabled: true
          profile: aggressive
          check_control_plane_failure: true

        # Additional BFD peers for monitoring
        peers:
          - address: 192.168.250.255
            profile: aggressive
            interface: veth-frr

          # Monitor upstream routers
          - address: 10.0.0.1
            profile: aggressive
            multihop: false
            local_address: 10.10.10.10

          - address: 10.0.0.2
            profile: normal
            multihop: false
            local_address: 10.10.10.10
    mountPath: /usr/local/etc/frr/config.yaml

  # FRR daemons configuration with BFD enabled
  - content: |
      zebra=true
      zebra_options="-n -A 127.0.0.1"
      bgpd=true
      bgpd_options="-A 127.0.0.1"
      staticd=true
      staticd_options="-A 127.0.0.1"
      bfdd=true
      bfdd_options="-A 127.0.0.1"
    mountPath: /usr/local/etc/frr/daemons

  # VTY shell configuration
  - content: |
      service integrated-vtysh-config
      hostname frr
    mountPath: /usr/local/etc/frr/vtysh.conf
